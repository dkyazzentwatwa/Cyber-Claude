/**
 * DeFiHackLabs Exploit Reference Database
 *
 * Curated database of real-world DeFi exploits from:
 * https://github.com/SunWeb3Sec/DeFiHackLabs
 *
 * Used to provide real-world context for detected vulnerabilities
 */

import { Web3VulnType, ExploitReference } from '../types.js';

/**
 * Extended exploit entry with additional metadata
 */
export interface ExploitEntry {
  id: string;
  protocol: string;
  date: string;
  chain: 'ETH' | 'BSC' | 'Polygon' | 'Arbitrum' | 'Optimism' | 'Avalanche' | 'Base' | 'Other';
  lossUSD: string;
  rootCause: Web3VulnType[];
  testFile: string;
  summary: string;
  txHash?: string;
}

/**
 * Curated database of high-impact DeFi exploits
 * Organized by primary vulnerability type
 */
export const DEFIHACKLABS_EXPLOITS: ExploitEntry[] = [
  // ============================================
  // PRECISION LOSS / ROUNDING ERRORS
  // ============================================
  {
    id: 'hundred-finance-2023',
    protocol: 'Hundred Finance',
    date: '2023-04-15',
    chain: 'Optimism',
    lossUSD: '$7.4M',
    rootCause: ['precision-loss'],
    testFile: '2023-04/HundredFinance_exp.sol',
    summary: 'Rounding error in cToken exchange rate calculation allowed attacker to drain pools',
  },
  {
    id: 'sentiment-2023',
    protocol: 'Sentiment Protocol',
    date: '2023-04-04',
    chain: 'Arbitrum',
    lossUSD: '$1M',
    rootCause: ['precision-loss', 'oracle-manipulation'],
    testFile: '2023-04/Sentiment_exp.sol',
    summary: 'Precision loss in Balancer pool integration led to incorrect pricing',
  },
  {
    id: 'wise-lending-2024',
    protocol: 'Wise Lending',
    date: '2024-01-12',
    chain: 'ETH',
    lossUSD: '$460K',
    rootCause: ['precision-loss', 'flash-loan-attack'],
    testFile: '2024-01/WiseLending02_exp.sol',
    summary: 'Precision loss in share calculation exploited via flash loan',
  },

  // ============================================
  // ARBITRARY EXTERNAL CALLS
  // ============================================
  {
    id: 'qubit-2022',
    protocol: 'Qubit Finance',
    date: '2022-01-28',
    chain: 'BSC',
    lossUSD: '$80M',
    rootCause: ['arbitrary-call', 'access-control'],
    testFile: '2022-01/Qubit_exp.sol',
    summary: 'Arbitrary call to bridge contract allowed minting unbacked tokens',
  },
  {
    id: 'multichain-2023',
    protocol: 'Multichain',
    date: '2023-07-07',
    chain: 'ETH',
    lossUSD: '$126M',
    rootCause: ['arbitrary-call', 'access-control'],
    testFile: '2023-07/Multichain_exp.sol',
    summary: 'Compromised MPC keys led to unauthorized cross-chain transfers',
  },
  {
    id: 'socket-gateway-2024',
    protocol: 'Socket Gateway',
    date: '2024-01-16',
    chain: 'ETH',
    lossUSD: '$3.3M',
    rootCause: ['arbitrary-call'],
    testFile: '2024-01/SocketGateway_exp.sol',
    summary: 'Unchecked external call in bridge aggregator allowed arbitrary token transfers',
  },

  // ============================================
  // STORAGE COLLISION / PROXY ISSUES
  // ============================================
  {
    id: 'audius-2022',
    protocol: 'Audius',
    date: '2022-07-23',
    chain: 'ETH',
    lossUSD: '$6M',
    rootCause: ['storage-collision', 'access-control'],
    testFile: '2022-07/Audius_exp.sol',
    summary: 'Storage collision in proxy allowed unauthorized governance proposal execution',
  },
  {
    id: 'furucombo-2021',
    protocol: 'Furucombo',
    date: '2021-02-27',
    chain: 'ETH',
    lossUSD: '$14M',
    rootCause: ['storage-collision', 'delegatecall-injection'],
    testFile: '2021-02/Furucombo_exp.sol',
    summary: 'Uninitialized proxy implementation allowed attacker to set malicious handler',
  },

  // ============================================
  // TIMESTAMP DEPENDENCE
  // ============================================
  {
    id: 'governance-attack-2022',
    protocol: 'Various',
    date: '2022-06-01',
    chain: 'ETH',
    lossUSD: 'N/A',
    rootCause: ['timestamp-dependence'],
    testFile: '2022-06/Timestamp_exp.sol',
    summary: 'Miner manipulation of block.timestamp to win time-based auctions',
  },

  // ============================================
  // WEAK RANDOMNESS
  // ============================================
  {
    id: 'fomo3d-2018',
    protocol: 'Fomo3D',
    date: '2018-08-22',
    chain: 'ETH',
    lossUSD: '$3M',
    rootCause: ['weak-randomness', 'front-running'],
    testFile: '2018-08/Fomo3D_exp.sol',
    summary: 'Block stuffing attack to win lottery by controlling block timing',
  },
  {
    id: 'meebits-2021',
    protocol: 'Meebits',
    date: '2021-05-08',
    chain: 'ETH',
    lossUSD: '$700K',
    rootCause: ['weak-randomness'],
    testFile: '2021-05/Meebits_exp.sol',
    summary: 'Predictable randomness allowed pre-selecting rare NFT traits',
  },

  // ============================================
  // REENTRANCY
  // ============================================
  {
    id: 'dao-2016',
    protocol: 'The DAO',
    date: '2016-06-17',
    chain: 'ETH',
    lossUSD: '$60M',
    rootCause: ['reentrancy'],
    testFile: '2016-06/TheDAO_exp.sol',
    summary: 'Classic reentrancy - external call before state update allowed recursive withdrawals',
  },
  {
    id: 'curve-2023',
    protocol: 'Curve Finance',
    date: '2023-07-30',
    chain: 'ETH',
    lossUSD: '$62M',
    rootCause: ['reentrancy'],
    testFile: '2023-07/Curve_exp.sol',
    summary: 'Vyper compiler bug led to reentrancy in multiple Curve pools',
  },
  {
    id: 'grim-finance-2021',
    protocol: 'Grim Finance',
    date: '2021-12-19',
    chain: 'Avalanche',
    lossUSD: '$30M',
    rootCause: ['reentrancy'],
    testFile: '2021-12/GrimFinance_exp.sol',
    summary: 'Reentrancy in vault deposit allowed recursive minting of shares',
  },

  // ============================================
  // FLASH LOAN ATTACKS
  // ============================================
  {
    id: 'euler-2023',
    protocol: 'Euler Finance',
    date: '2023-03-13',
    chain: 'ETH',
    lossUSD: '$197M',
    rootCause: ['flash-loan-attack', 'access-control'],
    testFile: '2023-03/Euler_exp.sol',
    summary: 'Flash loan enabled manipulation of health factor calculation',
  },
  {
    id: 'gamma-2024',
    protocol: 'Gamma Strategies',
    date: '2024-01-04',
    chain: 'Arbitrum',
    lossUSD: '$6.3M',
    rootCause: ['flash-loan-attack', 'oracle-manipulation'],
    testFile: '2024-01/Gamma_exp.sol',
    summary: 'Price manipulation through flash loan sandwich attack on UniProxy',
  },

  // ============================================
  // ORACLE MANIPULATION
  // ============================================
  {
    id: 'mango-2022',
    protocol: 'Mango Markets',
    date: '2022-10-11',
    chain: 'Other',
    lossUSD: '$114M',
    rootCause: ['oracle-manipulation', 'flash-loan-attack'],
    testFile: '2022-10/MangoMarkets_exp.sol',
    summary: 'Oracle manipulation by pumping illiquid token price to borrow against',
  },
  {
    id: 'bonq-2023',
    protocol: 'BonqDAO',
    date: '2023-02-01',
    chain: 'Polygon',
    lossUSD: '$120M',
    rootCause: ['oracle-manipulation'],
    testFile: '2023-02/BonqDAO_exp.sol',
    summary: 'Single-source Tellor oracle manipulated to inflate collateral value',
  },

  // ============================================
  // ACCESS CONTROL
  // ============================================
  {
    id: 'ronin-2022',
    protocol: 'Ronin Bridge',
    date: '2022-03-29',
    chain: 'ETH',
    lossUSD: '$624M',
    rootCause: ['access-control'],
    testFile: '2022-03/Ronin_exp.sol',
    summary: 'Compromised validator keys allowed unauthorized bridge withdrawals',
  },
  {
    id: 'wormhole-2022',
    protocol: 'Wormhole',
    date: '2022-02-02',
    chain: 'Other',
    lossUSD: '$326M',
    rootCause: ['access-control'],
    testFile: '2022-02/Wormhole_exp.sol',
    summary: 'Signature verification bypass allowed minting unbacked wETH',
  },
];

/**
 * Find exploits by vulnerability type
 */
export function findExploitsByVulnType(vulnType: Web3VulnType): ExploitEntry[] {
  return DEFIHACKLABS_EXPLOITS.filter(exploit =>
    exploit.rootCause.includes(vulnType)
  );
}

/**
 * Get DeFiHackLabs URL for an exploit
 */
export function getExploitUrl(exploit: ExploitEntry): string {
  return `https://github.com/SunWeb3Sec/DeFiHackLabs/blob/main/src/test/${exploit.testFile}`;
}

/**
 * Convert ExploitEntry to ExploitReference for findings
 */
export function toExploitReference(exploit: ExploitEntry): ExploitReference {
  return {
    protocol: exploit.protocol,
    date: exploit.date,
    chain: exploit.chain,
    lossAmount: exploit.lossUSD,
    rootCause: exploit.summary,
    defiHackLabsUrl: getExploitUrl(exploit),
    txHash: exploit.txHash,
  };
}

/**
 * Get exploit references for a vulnerability type
 * Returns top N most relevant exploits
 */
export function getExploitReferences(
  vulnType: Web3VulnType,
  limit: number = 3
): ExploitReference[] {
  const exploits = findExploitsByVulnType(vulnType);
  return exploits.slice(0, limit).map(toExploitReference);
}

/**
 * Get total loss amount for a vulnerability type
 */
export function getTotalLossForVulnType(vulnType: Web3VulnType): string {
  const exploits = findExploitsByVulnType(vulnType);
  let total = 0;

  for (const exploit of exploits) {
    const match = exploit.lossUSD.match(/\$?([\d.]+)([KMB])?/i);
    if (match) {
      let value = parseFloat(match[1]);
      const suffix = match[2]?.toUpperCase();
      if (suffix === 'K') value *= 1000;
      else if (suffix === 'M') value *= 1000000;
      else if (suffix === 'B') value *= 1000000000;
      total += value;
    }
  }

  if (total >= 1000000000) return `$${(total / 1000000000).toFixed(1)}B`;
  if (total >= 1000000) return `$${(total / 1000000).toFixed(1)}M`;
  if (total >= 1000) return `$${(total / 1000).toFixed(1)}K`;
  return `$${total}`;
}
